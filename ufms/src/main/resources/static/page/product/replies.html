<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>回复详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="icon" href="../../images/favicon.ico">
    <link rel="stylesheet" href="../../lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/themes/default.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <link rel="stylesheet" href="../../css/feedback.css" media="all">
    <link rel="stylesheet" href="../../lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all">
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.statidcfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>

<!--回复列表-->
<div class="layui-container">
    <span class="layui-breadcrumb">
      <a id="backHome">首页</a>
      <a><cite>反馈详情</cite></a>
    </span>
    <!--头部的反馈-->
    <ul style="margin-top: 20px" id="originalFeedback"></ul>
    <div style="margin-top: 10px">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend>评论<span id="repliesTitleCnt" style="margin-left: 5px;"></span></legend>
        </fieldset>
        <form class="layui-form" action="" id="formFeedback">
            <div class="layui-card" style="margin: 10px;">
                <div class="layui-card-body" style="padding-bottom: 0">
                    <div class="layui-form-item layui-form-text" style="margin-bottom: 0;">

                        <div id="avatarDefault" class="avatar-container" style="float: left;display: none">
                            <span class="avatar-content">像</span>
                        </div>

                        <div id="customUserInfo" style="display: none">
                            <img id="avatarUser" class="layui-nav-img" alt="" src="">
                            <span id="userName"></span>
                        </div>

                        <div class="layui-input-block" style="margin-left: 50px">
                                <textarea name="content" class="layui-textarea" id="area" maxlength="500"
                                          placeholder="别害羞，快来说两句吧" lay-verify="required"></textarea>
                            <div style="margin-top: 10px;margin-right: 8px; text-align: left;">
                                <span id="textarea_length">0</span> / <span class="num_count">500</span>
                            </div>
                        </div>
                    </div>
                    <div class="layui-card-header" style="padding-bottom: 10px;">
                        <div class="layui-form-item">
                            <div class="layui-input-block" style="text-align: right">
                                <button class="layui-btn" lay-submit lay-filter="submit">评论</button>
                                <button type="reset" class="layui-btn layui-btn-primary" id="buttonReset">重置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <ul id="flows">
        </ul>
    </div>
</div>

<script src="../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="../../js/lay-config.js" charset="utf-8"></script>
<script type="module" src="../../js/my-config.js" charset="utf-8"></script>
<script>
    layui.use(['layer', 'element', 'flow', 'form'], function () {
        let $ = layui.jquery,//不用额外加载jQuery，flow模块本身是有依赖jQuery的，直接用即可。
            layer = layui.layer,
            form = layui.form,
            flow = layui.flow;

        $(() => {
            let product, original = null;
            let productId = window.UTIL.getUrlParam("pid");
            let originalId = window.UTIL.getUrlParam("oid");
            let userUuid = window.UTIL.getUrlParam("uid");
            let userName = window.UTIL.getUrlParam("uname");
            let userAvatar = window.UTIL.getUrlParam("uavatar");
            let customUserInfo = window.UTIL.getCustomUserInfo();
            console.log(customUserInfo)
            if (customUserInfo === null) {
                $("#avatarDefault").css("display", "")
            } else {
                $("#customUserInfo").css("display", "")
                let avatarUser = $("#avatarUser");
                avatarUser.attr("src", customUserInfo.userAvatar)

                let $userName = $("#userName");
                $userName.text(customUserInfo.userName)
            }
            console.log($.getAllUrlParams())
            if (productId !== null && productId > 0) {
                $.ajax({
                    type: "GET",
                    url: window.API.PRODUCT.FIND + productId,
                    headers: {
                        "Content-Type": "application/json;charset=utf-8"
                    },
                    success: (response) => {
                        if (response.success) {
                            //监听textarea
                            $('#area').bind('input propertychange', 'textarea', function () {
                                    let obj = $(this)
                                    // console.log(obj)
                                    let maxlength = obj.attr('maxlength')
                                    let curr = obj.context.value.length;
                                    if (curr > maxlength) {
                                        layer.msg('字数在' + maxlength + '字以内');
                                    } else {
                                        $("#textarea_length").text(curr)
                                    }
                                }
                            )
                            $("#buttonReset").on("click", () => $("#textarea_length").text(0))
                            product = response.data
                            //监听提交
                            form.on('submit(submit)', function (data) {
                                let field = data.field;
                                field.product = {id: productId}
                                field.original = {id: originalId}
                                field.userUuid = userUuid
                                field.userName = userName
                                field.userAvatar = userAvatar
                                console.log(field)

                                $.ajax({
                                    type: "PUT",
                                    url: window.API.FEEDBACK.INSERT,
                                    data: JSON.stringify(field),
                                    headers: {
                                        "Content-Type": "application/json;charset=utf-8"
                                    },
                                    dataType: "json",
                                    success: (res) => {
                                        layer.msg("评论成功")
                                        $("#flows").prepend(
                                            window.UTIL.generateFlowItem(res.data, {
                                                productId: productId,
                                                isReplies: true,
                                                userUuid: userUuid,
                                                userName: userName,
                                                userAvatar: userAvatar
                                            }).replaceAll('lay-src="', 'src="'))
                                        $("#repliesTitleCnt").text(parseInt($("#repliesTitleCnt")[0].innerText) + 1)
                                        $("#textarea_length").text(0)
                                        $("#formFeedback")[0].reset();
                                        form.render()
                                    }
                                })
                                return false;
                            });

                            $("#backHome").attr("href",
                                window.UTIL.getFullProductFeedbackPath({
                                    productId: productId,
                                    originalId: originalId,
                                    userUuid: userUuid,
                                    userName: userName,
                                    userAvatar: userAvatar
                                }))

                            flow.load({
                                elem: '#flows',
                                // scrollElem: '#flows',
                                // isAuto: false,
                                isLazyimg: true,
                                end: "<div class='layui-card layui-card-body' style='margin: 10px'>没有更多了</div>",
                                done: function (page, next) {
                                    setTimeout(function () {
                                        //减去底部加载更多的一个
                                        let currentCnt = $("#flows")[0].children.length
                                        console.log(currentCnt)
                                        let lis = [];
                                        $.ajax({
                                            type: "GET",
                                            url: window.API.FEEDBACK.FIND_ALL_FEEDBACK_REPLIES + product.id + "&offset=" + (currentCnt - 1) + "&feedbackId=" + originalId,
                                            success: (res) => {
                                                if (!res.data.empty) {
                                                    $("#repliesTitleCnt").text(res.data.totalElements)
                                                    if (original === null) {
                                                        original = res.data.content[0].original
                                                        original.replies = null
                                                        $("#originalFeedback").append(window.UTIL.generateFlowItem(original,
                                                            {
                                                                productId: productId,
                                                                userUuid: userUuid,
                                                                userName: userName,
                                                                userAvatar: userAvatar
                                                            })
                                                        )
                                                    }
                                                }
                                                layui.each(res.data.content, function (index, item) {
                                                    lis.push(window.UTIL.generateFlowItem(item, {
                                                        isReplies: true,
                                                        productId: productId,
                                                        userUuid: userUuid,
                                                        userName: userName,
                                                        userAvatar: userAvatar
                                                    }));
                                                });
                                                next(lis.join(''), page < res.data.totalPages);
                                            }
                                        });
                                    }, 500);
                                }
                            })
                        } else {
                            window.location.replace("/page/product/not-found.html")
                        }
                    }
                })

                $(document).on('click', 'i.iconButton', function () {
                    //TODO 置顶、隐藏、锁定、标记为好问题、回复
                    let feedbackId = $(this).attr("fid")
                    let productId = $(this).attr("pid")
                    layer.msg(feedbackId + "," + productId + "," + $(this).attr("type"))
                    switch ($(this).attr("type")) {
                        case "top": {
                            break
                        }
                        case "hide": {
                            break
                        }
                        case "lock": {
                            break
                        }
                        case "recommend": {
                            break
                        }
                        case "like": {
                            break
                        }
                        case "reply": {
                            break
                        }
                        default: {
                        }
                    }
                })

            } else {
                window.location.replace("/page/404.html")
            }
        })

    })

</script>
</body>
</html>